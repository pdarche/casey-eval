{% extends "base.html" %}

{% block title %}{{ version.version }} - Casey Eval{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="/" class="text-blue-600 hover:text-blue-800 text-sm">&larr; Back to Dashboard</a>
    <div class="flex items-center gap-3 mt-2">
        <h1 class="text-2xl font-bold text-gray-800">{{ version.version }}</h1>
        <span id="run-status-badge">
            {% if run_status == 'running' %}
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 animate-pulse">Running</span>
            {% elif run_status == 'judging' %}
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800 animate-pulse">Judging</span>
            {% elif run_status == 'completed' %}
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Completed</span>
            {% elif run_status == 'failed' %}
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Failed</span>
            {% endif %}
        </span>
    </div>
    <p class="text-gray-600 mt-1">
        <span id="run-progress">
            {% if run_status == 'running' %}
                <span class="text-blue-600">Running conversations...</span>
            {% elif run_status == 'judging' %}
                <span class="text-purple-600">Running judges...</span>
            {% else %}
                {{ version.start_time[:19] if version.start_time else '' }}
            {% endif %}
        </span>
    </p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500 uppercase tracking-wide">Conversations</div>
        <div id="stat-conversations" class="text-3xl font-bold text-gray-800 mt-1">{{ version.conversation_count }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500 uppercase tracking-wide">Completion Rate</div>
        <div id="stat-completion" class="text-3xl font-bold mt-1 {% if version.completion_rate >= 0.8 %}text-green-600{% elif version.completion_rate >= 0.5 %}text-yellow-600{% else %}text-red-600{% endif %}">{{ (version.completion_rate * 100)|int }}%</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500 uppercase tracking-wide">Safety Pass Rate</div>
        <div id="stat-safety" class="text-3xl font-bold {% if version.safety_pass_rate == 1 %}text-green-600{% elif version.safety_pass_rate is not none %}text-red-600{% else %}text-gray-400{% endif %} mt-1">
            {% if version.safety_pass_rate is not none %}
                {{ (version.safety_pass_rate * 100)|int }}%
            {% else %}
                -
            {% endif %}
        </div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500 uppercase tracking-wide">Avg Quality</div>
        <div id="stat-quality" class="text-3xl font-bold text-gray-800 mt-1">
            {% if version.avg_quality_score is not none %}
                {{ "%.1f"|format(version.avg_quality_score) }}/5
            {% else %}
                -
            {% endif %}
        </div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500 uppercase tracking-wide">Completeness</div>
        <div id="stat-completeness" class="text-3xl font-bold text-gray-800 mt-1">
            {% if version.avg_intake_completeness is not none %}
                {{ "%.1f"|format(version.avg_intake_completeness) }}/5
            {% else %}
                -
            {% endif %}
        </div>
    </div>
</div>

<!-- Run Summary -->
<div class="bg-white rounded-lg shadow p-6 mb-8">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-800">Run Summary</h2>
        <button
            id="generate-summary-btn"
            onclick="generateSummary()"
            class="px-3 py-1 text-sm font-medium text-blue-600 hover:text-blue-800 border border-blue-600 rounded-lg hover:bg-blue-50">
            {% if ai_summary %}Regenerate{% else %}Generate Summary{% endif %}
        </button>
    </div>
    <div id="summary-content">
        {% if ai_summary %}
            <div id="saved-summary-md" class="hidden">{{ ai_summary }}</div>
            <div id="saved-summary-rendered" class="markdown-content"></div>
        {% else %}
            <p class="text-gray-500 text-sm">Click "Generate Summary" to get an AI-powered analysis of this run's performance with recommendations for prompt improvements.</p>
        {% endif %}
    </div>
    <div id="summary-loading" class="hidden">
        <div class="flex items-center gap-3">
            <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-600">Analyzing run results...</span>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
let pollingInterval = null;
let currentStatus = '{{ run_status }}';
let previousStatus = '{{ run_status }}';

async function pollStatus() {
    try {
        const response = await fetch('/api/version/{{ version.version }}/status');
        if (!response.ok) return;

        const data = await response.json();

        // Update status badge
        const badge = document.getElementById('run-status-badge');
        const progress = document.getElementById('run-progress');

        if (data.status === 'running') {
            badge.innerHTML = '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 animate-pulse">Running</span>';
            progress.innerHTML = `<span class="text-blue-600">${data.conversation_count}/${data.target_count} conversations...</span>`;
        } else if (data.status === 'judging') {
            badge.innerHTML = '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800 animate-pulse">Judging</span>';
            progress.innerHTML = `<span class="text-purple-600">${data.judged_count}/${data.conversation_count} judged...</span>`;
        } else if (data.status === 'completed') {
            badge.innerHTML = '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Completed</span>';
            progress.innerHTML = '';

            // Update stats
            document.getElementById('stat-conversations').textContent = data.conversation_count;
            if (data.safety_pass_rate !== null) {
                const safetyEl = document.getElementById('stat-safety');
                const pct = Math.round(data.safety_pass_rate * 100);
                safetyEl.textContent = pct + '%';
                safetyEl.className = 'text-3xl font-bold mt-1 ' + (pct === 100 ? 'text-green-600' : 'text-red-600');
            }
            if (data.avg_quality_score !== null) {
                document.getElementById('stat-quality').textContent = data.avg_quality_score.toFixed(1) + '/5';
            }
            if (data.avg_completeness !== null) {
                document.getElementById('stat-completeness').textContent = data.avg_completeness.toFixed(1) + '/5';
            }

            // Stop polling when completed
            if (currentStatus !== 'completed') {
                stopPolling();
                // Auto-generate summary if just completed from judging
                if (previousStatus === 'judging') {
                    generateSummary();
                }
                // Reload after a delay to get full conversation data
                setTimeout(() => window.location.reload(), 3000);
            }
        } else if (data.status === 'failed') {
            badge.innerHTML = '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Failed</span>';
            progress.innerHTML = '';
            stopPolling();
        }

        previousStatus = currentStatus;
        currentStatus = data.status;
    } catch (err) {
        console.error('Error polling status:', err);
    }
}

function startPolling() {
    if (pollingInterval) return;
    pollingInterval = setInterval(pollStatus, 2000);
}

function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

// Start polling if run is active, render saved summary
document.addEventListener('DOMContentLoaded', function() {
    if (currentStatus === 'running' || currentStatus === 'judging') {
        startPolling();
    }

    // Render saved summary if present
    const savedMd = document.getElementById('saved-summary-md');
    const savedRendered = document.getElementById('saved-summary-rendered');
    if (savedMd && savedRendered) {
        savedRendered.innerHTML = marked.parse(savedMd.textContent);
    }
});

async function generateSummary() {
    const btn = document.getElementById('generate-summary-btn');
    const content = document.getElementById('summary-content');
    const loading = document.getElementById('summary-loading');

    btn.disabled = true;
    btn.classList.add('opacity-50');
    content.classList.add('hidden');
    loading.classList.remove('hidden');

    try {
        const response = await fetch('/api/version/{{ version.version }}/summary');
        const result = await response.json();

        loading.classList.add('hidden');
        content.classList.remove('hidden');

        if (response.ok) {
            content.innerHTML = '<div class="markdown-content">' + marked.parse(result.summary) + '</div>';
            btn.textContent = 'Regenerate';
        } else {
            content.innerHTML = '<p class="text-red-600">Error: ' + (result.error || 'Failed to generate summary') + '</p>';
        }
    } catch (err) {
        loading.classList.add('hidden');
        content.classList.remove('hidden');
        content.innerHTML = '<p class="text-red-600">Error: ' + err.message + '</p>';
    }

    btn.disabled = false;
    btn.classList.remove('opacity-50');
}
</script>

<!-- Conversations Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="px-6 py-4 border-b">
        <h2 class="text-lg font-semibold text-gray-800">Conversations</h2>
    </div>
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Persona
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Language
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Issue
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Turns
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Duration
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Status
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Safety
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Quality
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Completeness
                </th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for conv in version.conversations %}
            <tr class="hover:bg-gray-50 cursor-pointer" onclick="window.location='/conversation-by-file?path={{ conv.filepath|urlencode }}'">
                <td class="px-6 py-4 whitespace-nowrap">
                    <a href="/conversation-by-file?path={{ conv.filepath|urlencode }}" class="text-blue-600 hover:text-blue-800 font-medium">
                        {{ conv.persona_name }}
                    </a>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ conv.language }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ conv.legal_issue }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {{ conv.turn_count }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ "%.1f"|format(conv.duration_seconds) }}s
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    {% if conv.completion_reason == 'intake_complete' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            Complete
                        </span>
                    {% elif conv.completion_reason == 'error' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            Error
                        </span>
                    {% elif conv.completion_reason == 'max_turns' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            Max Turns
                        </span>
                    {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            {{ conv.completion_reason }}
                        </span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    {% if conv.has_eval %}
                        {% if conv.safety_passed %}
                            <span class="text-green-600 font-medium">Pass</span>
                        {% else %}
                            <span class="text-red-600 font-medium">Fail</span>
                        {% endif %}
                    {% else %}
                        <span class="text-gray-400">-</span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    {% if conv.has_eval and conv.quality_score is not none %}
                        <span class="{% if conv.quality_score >= 4 %}text-green-600{% elif conv.quality_score >= 3 %}text-yellow-600{% else %}text-red-600{% endif %}">
                            {{ "%.1f"|format(conv.quality_score) }}/5
                        </span>
                    {% else %}
                        <span class="text-gray-400">-</span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    {% if conv.has_eval and conv.intake_completeness is not none %}
                        <span class="text-gray-900">{{ "%.1f"|format(conv.intake_completeness) }}/5</span>
                    {% else %}
                        <span class="text-gray-400">-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
